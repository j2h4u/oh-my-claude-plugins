name: Validate Plugins

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup jq
        uses: dcarbone/install-jq-action@v3

      - name: Validate marketplace.json
        run: |
          echo "Validating marketplace.json..."
          jq empty .claude-plugin/marketplace.json
          echo "✓ Marketplace JSON is valid"

      - name: Check required fields in marketplace
        run: |
          echo "Checking required marketplace fields..."

          # Check top-level required fields
          if ! jq -e ".name" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: name"
            exit 1
          fi
          echo "✓ Field 'name' present"

          if ! jq -e ".owner" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: owner"
            exit 1
          fi
          echo "✓ Field 'owner' present"

          # Check owner.name exists
          if ! jq -e ".owner.name" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: owner.name"
            exit 1
          fi
          echo "✓ Field 'owner.name' present"

          if ! jq -e ".plugins" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: plugins"
            exit 1
          fi
          echo "✓ Field 'plugins' present"

          # Check plugins is an array
          if ! jq -e ".plugins | type == \"array\"" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Field 'plugins' must be an array"
            exit 1
          fi
          echo "✓ Field 'plugins' is an array"

  validate-marketplace-plugins:
    name: Validate Marketplace Plugin Entries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup jq
        uses: dcarbone/install-jq-action@v3

      - name: Validate marketplace plugin entries
        run: |
          echo "Validating marketplace plugin entries..."

          # Check each plugin entry in marketplace
          plugin_count=$(jq '.plugins | length' .claude-plugin/marketplace.json)

          for ((i=0; i<$plugin_count; i++)); do
            echo ""
            echo "Checking marketplace entry $((i+1))..."

            # Check required fields for marketplace entries
            if ! jq -e ".plugins[$i].name" .claude-plugin/marketplace.json > /dev/null; then
              echo "✗ Plugin entry $((i+1)): Missing required field 'name'"
              exit 1
            fi

            if ! jq -e ".plugins[$i].source" .claude-plugin/marketplace.json > /dev/null; then
              echo "✗ Plugin entry $((i+1)): Missing required field 'source'"
              exit 1
            fi

            # Check author format if present
            if jq -e ".plugins[$i].author" .claude-plugin/marketplace.json > /dev/null; then
              if ! jq -e ".plugins[$i].author | type == \"object\"" .claude-plugin/marketplace.json > /dev/null; then
                echo "✗ Plugin entry $((i+1)): Field 'author' must be an object"
                exit 1
              fi
              if ! jq -e ".plugins[$i].author.name" .claude-plugin/marketplace.json > /dev/null; then
                echo "✗ Plugin entry $((i+1)): Field 'author.name' is required when 'author' is present"
                exit 1
              fi
              echo "✓ Plugin entry $((i+1)): Field 'author' is properly formatted"
            fi

            plugin_name=$(jq -r ".plugins[$i].name" .claude-plugin/marketplace.json)
            echo "✓ Marketplace entry for '$plugin_name' is valid"
          done

          echo ""
          echo "✅ All marketplace plugin entries are valid"

  validate-plugins:
    name: Validate Individual Plugins
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup jq
        uses: dcarbone/install-jq-action@v3

      - name: Validate each plugin
        run: |
          echo "Validating plugin files..."

          # Get all plugin paths
          plugins=$(jq -r '.plugins[] | select(.source | type == "string") | .source' .claude-plugin/marketplace.json)

          for plugin_path in $plugins; do
            plugin_name=$(basename "$plugin_path")
            echo ""
            echo "Checking plugin: $plugin_name"
            echo "================================"

            # Check directory exists
            if [ ! -d "$plugin_path" ]; then
              echo "✗ Directory not found: $plugin_path"
              exit 1
            fi
            echo "✓ Directory exists"

            # Check plugin.json exists
            plugin_json="$plugin_path/.claude-plugin/plugin.json"
            if [ ! -f "$plugin_json" ]; then
              echo "✗ plugin.json not found at $plugin_json"
              exit 1
            fi
            echo "✓ plugin.json exists"

            # Validate JSON syntax
            if ! jq empty "$plugin_json" 2>/dev/null; then
              echo "✗ Invalid JSON in $plugin_json"
              exit 1
            fi
            echo "✓ plugin.json is valid JSON"

            # Check required fields (only 'name' is required)
            if ! jq -e ".name" "$plugin_json" > /dev/null; then
              echo "✗ Missing required field: name"
              exit 1
            fi
            echo "✓ Required field 'name' present"

            # Check optional but recommended fields
            if jq -e ".author" "$plugin_json" > /dev/null; then
              # If author exists, check it's an object
              if ! jq -e ".author | type == \"object\"" "$plugin_json" > /dev/null; then
                echo "✗ Field 'author' must be an object with 'name' field"
                exit 1
              fi
              if ! jq -e ".author.name" "$plugin_json" > /dev/null; then
                echo "✗ Field 'author.name' is required when 'author' is present"
                exit 1
              fi
              echo "✓ Field 'author' is properly formatted"
            fi

            # Validate repository field if present (should be string, not object)
            if jq -e ".repository" "$plugin_json" > /dev/null; then
              if ! jq -e ".repository | type == \"string\"" "$plugin_json" > /dev/null; then
                echo "✗ Field 'repository' must be a string URL, not an object"
                exit 1
              fi
              echo "✓ Field 'repository' is properly formatted"
            fi

            # Check README exists
            if [ ! -f "$plugin_path/README.md" ]; then
              echo "⚠️  Warning: README.md not found (recommended)"
            else
              echo "✓ README.md exists"
            fi

            # Check hooks configuration
            if [ -d "$plugin_path/hooks" ]; then
              echo "✓ Hooks directory exists"

              # Check if standard hooks/hooks.json exists
              standard_hooks="$plugin_path/hooks/hooks.json"
              if [ -f "$standard_hooks" ]; then
                # Standard hooks.json exists - validate it
                if ! jq empty "$standard_hooks" 2>/dev/null; then
                  echo "✗ Invalid JSON in hooks file: $standard_hooks"
                  exit 1
                fi

                # If hooks field is present, it should NOT point to standard location
                if jq -e ".hooks" "$plugin_json" > /dev/null; then
                  hooks_path=$(jq -r ".hooks" "$plugin_json")
                  if [ "$hooks_path" = "./hooks/hooks.json" ] || [ "$hooks_path" = "hooks/hooks.json" ]; then
                    echo "✗ Field 'hooks' should not reference standard hooks/hooks.json"
                    echo "  Standard hooks/hooks.json is loaded automatically"
                    echo "  Use 'hooks' field only for additional hook files"
                    exit 1
                  fi
                fi

                echo "✓ Standard hooks configuration is valid"
              else
                # No standard hooks.json - hooks field is required
                if ! jq -e ".hooks" "$plugin_json" > /dev/null; then
                  echo "✗ Hooks directory exists but no hooks/hooks.json found"
                  echo "  Either create hooks/hooks.json or specify custom path in 'hooks' field"
                  exit 1
                fi

                # Verify custom hooks file exists
                hooks_path=$(jq -r ".hooks" "$plugin_json")
                hooks_file="$plugin_path/$hooks_path"
                if [ ! -f "$hooks_file" ]; then
                  echo "✗ Hooks file not found: $hooks_file"
                  exit 1
                fi

                # Validate hooks JSON syntax
                if ! jq empty "$hooks_file" 2>/dev/null; then
                  echo "✗ Invalid JSON in hooks file: $hooks_file"
                  exit 1
                fi

                echo "✓ Custom hooks configuration is valid"
              fi
            elif jq -e ".hooks" "$plugin_json" > /dev/null; then
              echo "✗ Field 'hooks' present but hooks directory not found"
              exit 1
            fi

            # Check commands directory and validate command files
            if [ -d "$plugin_path/commands" ]; then
              echo "✓ Commands directory exists"

              # Find all markdown files in commands directory
              command_files=$(find "$plugin_path/commands" -name "*.md" 2>/dev/null)

              if [ -n "$command_files" ]; then
                for cmd_file in $command_files; do
                  cmd_name=$(basename "$cmd_file")

                  # Check if file has frontmatter (starts with ---)
                  if head -n 1 "$cmd_file" | grep -q "^---$"; then
                    echo "✓ Command '$cmd_name' has frontmatter"
                  else
                    echo "⚠️  Warning: Command '$cmd_name' missing frontmatter (recommended)"
                  fi
                done
              fi
            fi

            echo "✓ Plugin $plugin_name is valid"
          done

          echo ""
          echo "================================"
          echo "✅ All plugins validated successfully!"

  check-duplicates:
    name: Check for Duplicate Plugin Names
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup jq
        uses: dcarbone/install-jq-action@v3

      - name: Check for duplicate names
        run: |
          echo "Checking for duplicate plugin names..."

          duplicates=$(jq -r '.plugins[].name' .claude-plugin/marketplace.json | sort | uniq -d)

          if [ -n "$duplicates" ]; then
            echo "✗ Duplicate plugin names found:"
            echo "$duplicates"
            exit 1
          fi

          echo "✓ No duplicate plugin names"

  shellcheck-scripts:
    name: Shellcheck Bash Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck on all bash scripts
        run: |
          echo "Running shellcheck on bash scripts..."

          # Find all .sh files
          bash_scripts=$(find . -name "*.sh" -type f | grep -v ".git" | grep -v "node_modules")

          if [ -z "$bash_scripts" ]; then
            echo "No bash scripts found"
            exit 0
          fi

          exit_code=0
          for script in $bash_scripts; do
            echo ""
            echo "Checking: $script"
            if shellcheck "$script"; then
              echo "✓ $script passed shellcheck"
            else
              echo "✗ $script failed shellcheck"
              exit_code=1
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo ""
            echo "✅ All bash scripts passed shellcheck"
          else
            echo ""
            echo "❌ Some scripts failed shellcheck"
            exit 1
          fi

  validate-frontmatter:
    name: Validate YAML Frontmatter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Python and PyYAML
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install PyYAML

      - name: Validate frontmatter in SKILL.md files
        run: |
          echo "Validating YAML frontmatter in SKILL.md files..."

          skill_files=$(find . -name "SKILL.md" -type f)

          exit_code=0
          for skill_file in $skill_files; do
            echo ""
            echo "Checking: $skill_file"

            # Check if file starts with ---
            if ! head -n 1 "$skill_file" | grep -q "^---$"; then
              echo "✗ Missing frontmatter delimiter at start"
              exit_code=1
              continue
            fi

            # Extract frontmatter and validate YAML
            frontmatter=$(awk '/^---$/{i++}i==1{print;next}i==2{exit}' "$skill_file" | sed '1d')

            pycheck='import sys,yaml;d=yaml.safe_load(sys.stdin)'
            if echo "$frontmatter" | python3 -c "$pycheck" 2>/dev/null; then
              # Check required fields
              pychk_name="$pycheck;sys.exit(0 if 'name' in d else 1)"
              if ! echo "$frontmatter" | python3 -c "$pychk_name"; then
                echo "✗ Missing required field: name"
                exit_code=1
                continue
              fi

              pychk_desc="$pycheck;sys.exit(0 if 'description' in d else 1)"
              if ! echo "$frontmatter" | python3 -c "$pychk_desc"; then
                echo "✗ Missing required field: description"
                exit_code=1
                continue
              fi

              echo "✓ Valid frontmatter with required fields"
            else
              echo "✗ Invalid YAML in frontmatter"
              exit_code=1
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo ""
            echo "✅ All SKILL.md frontmatter is valid"
          else
            echo ""
            echo "❌ Some SKILL.md files have invalid frontmatter"
            exit 1
          fi

      - name: Validate frontmatter in agent files
        run: |
          echo "Validating YAML frontmatter in agent files..."

          agent_files=$(find ./agents -name "*.md" -type f -path "*/agents/*" 2>/dev/null || true)

          if [ -z "$agent_files" ]; then
            echo "No agent files found"
            exit 0
          fi

          exit_code=0
          for agent_file in $agent_files; do
            echo ""
            echo "Checking: $agent_file"

            # Check if file starts with ---
            if ! head -n 1 "$agent_file" | grep -q "^---$"; then
              echo "✗ Missing frontmatter delimiter at start"
              exit_code=1
              continue
            fi

            # Extract frontmatter and validate YAML
            frontmatter=$(awk '/^---$/{i++}i==1{print;next}i==2{exit}' "$agent_file" | sed '1d')

            pycheck='import sys,yaml;d=yaml.safe_load(sys.stdin)'
            if echo "$frontmatter" | python3 -c "$pycheck" 2>/dev/null; then
              # Check required fields
              pychk_name="$pycheck;sys.exit(0 if 'name' in d else 1)"
              if ! echo "$frontmatter" | python3 -c "$pychk_name"; then
                echo "✗ Missing required field: name"
                exit_code=1
                continue
              fi

              pychk_desc="$pycheck;sys.exit(0 if 'description' in d else 1)"
              if ! echo "$frontmatter" | python3 -c "$pychk_desc"; then
                echo "✗ Missing required field: description"
                exit_code=1
                continue
              fi

              echo "✓ Valid frontmatter with required fields"
            else
              echo "✗ Invalid YAML in frontmatter"
              exit_code=1
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo ""
            echo "✅ All agent frontmatter is valid"
          else
            echo ""
            echo "❌ Some agent files have invalid frontmatter"
            exit 1
          fi

  validate-skill-descriptions:
    name: Validate Skill Description Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Python and PyYAML
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install PyYAML

      - name: Check skill description format
        run: |
          echo "Validating skill description format (CRITICAL for discovery)..."
          echo "According to CLAUDE.md: descriptions must use third-person"
          echo "and include 8-12 quoted trigger phrases"
          echo ""

          skill_files=$(find . -name "SKILL.md" -type f)

          exit_code=0
          pyget_desc='import sys,yaml;d=yaml.safe_load(sys.stdin);print(d.get("description",""))'

          for skill_file in $skill_files; do
            echo "Checking: $skill_file"

            # Extract description from frontmatter
            frontmatter=$(awk '/^---$/{i++}i==1{print;next}i==2{exit}' "$skill_file" | sed '1d')
            description=$(echo "$frontmatter" | python3 -c "$pyget_desc" 2>/dev/null || echo "")

            if [ -z "$description" ]; then
              echo "✗ No description found"
              exit_code=1
              continue
            fi

            # Check if description starts with "This skill should be used when"
            if ! echo "$description" | grep -q "This skill should be used when"; then
              echo "✗ Description must start with 'This skill should be used when'"
              echo "  Got: ${description:0:80}..."
              exit_code=1
              continue
            fi

            # Count quoted phrases (approximate - looks for "phrase" patterns)
            quoted_count=$(echo "$description" | grep -o '"[^"]*"' | wc -l)

            if [ "$quoted_count" -lt 3 ]; then
              echo "⚠️  Warning: Only $quoted_count quoted trigger phrases found (recommended: 8-12)"
              echo "  This may affect skill discovery"
            fi

            echo "✓ Description format is valid (${quoted_count} quoted phrases)"
          done

          if [ $exit_code -eq 0 ]; then
            echo ""
            echo "✅ All skill descriptions follow the required format"
          else
            echo ""
            echo "❌ Some skill descriptions don't follow the required format"
            exit 1
          fi

  check-hook-scripts-executable:
    name: Check Hook Scripts Are Executable
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check hook scripts are executable
        run: |
          echo "Checking that hook scripts are executable..."

          # Find all hook script files
          hook_scripts=$(find . -path "*/hooks/scripts/*.sh" -type f 2>/dev/null || true)

          if [ -z "$hook_scripts" ]; then
            echo "No hook scripts found"
            exit 0
          fi

          exit_code=0
          for script in $hook_scripts; do
            echo ""
            echo "Checking: $script"

            if [ -x "$script" ]; then
              echo "✓ Script is executable"
            else
              echo "✗ Script is NOT executable (needs chmod +x)"
              exit_code=1
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo ""
            echo "✅ All hook scripts are executable"
          else
            echo ""
            echo "❌ Some hook scripts are missing executable permissions"
            echo "Run: chmod +x <script-path>"
            exit 1
          fi

  validate-hooks-schema:
    name: Validate Hooks Against Schema
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Python and jsonschema
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install jsonschema

      - name: Validate hooks.json files
        run: |
          python3 docs/plugin-development/schemas/validate-hooks.py
